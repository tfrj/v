<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Ultimate Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --primary: #e50914; --bg: #0f0f0f; --panel: #1a1a1a; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: #000; padding: 15px; text-align: center; border-bottom: 3px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .controls { padding: 15px; background: var(--panel); display: flex; gap: 10px; justify-content: center; z-index: 10; }
        input { flex: 0.8; padding: 12px; border-radius: 5px; border: 1px solid #333; background: #000; color: #fff; outline: none; }
        input:focus { border-color: var(--primary); }
        button { padding: 10px 25px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #b20710; transform: scale(1.05); }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        #playlist { width: 350px; background: var(--panel); overflow-y: auto; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .channel-card { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .channel-card:hover { background: #252525; border-right: 4px solid var(--primary); }
        .channel-card img { width: 40px; height: 40px; object-fit: contain; background: #000; border-radius: 4px; }
        #video-container { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .status { padding: 20px; text-align: center; color: #888; font-size: 0.9em; }
    </style>
</head>
<body>

<header><h1>ğŸ“º IPTV PLAYER PRO</h1></header>

<div class="controls">
    <input type="text" id="m3u-url" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· M3U Ù‡Ù†Ø§..." value="">
    <button onclick="smartFetch()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
</div>

<div class="main-content">
    <div id="playlist"><div class="status">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    <div id="video-container">
        <video id="video" controls autoplay></video>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const playlistDiv = document.getElementById('playlist');

    async function smartFetch() {
        const url = document.getElementById('m3u-url').value.trim();
        if (!url) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·");

        playlistDiv.innerHTML = '<div class="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰...</div>';

        // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù€ Proxy Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹
        const proxies = [
            (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
            (u) => `https://thingproxy.freeboard.io/fetch/${u}`,
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`
        ];

        let content = null;

        for (let i = 0; i < proxies.length; i++) {
            try {
                playlistDiv.innerHTML = `<div class="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© (${i+1})...</div>`;
                const response = await fetch(proxies[i](url));
                const data = await response.json();
                content = data.contents || data; // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
                if (content && content.includes('#EXTM3U')) break;
            } catch (e) { console.log(`Proxy ${i} failed`); }
        }

        if (content) {
            parseAndDisplay(content);
        } else {
            playlistDiv.innerHTML = '<div class="status" style="color:#ff4d4d">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±. Ø§Ù„Ø±Ø§Ø¨Ø· Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø£Ùˆ Ù…Ø­Ù…ÙŠ Ø¨Ù‚ÙˆØ©.</div>';
        }
    }

    function parseAndDisplay(text) {
        const lines = text.split('\n');
        const channels = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('#EXTINF')) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù…
                const titleMatch = line.match(/,(.*)$/);
                const title = titleMatch ? titleMatch[1] : "Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø¥Ù† ÙˆØ¬Ø¯
                const logoMatch = line.match(/tvg-logo="(.*?)"/);
                const logo = logoMatch ? logoMatch[1] : "https://via.placeholder.com/40?text=TV";

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©
                let channelUrl = "";
                for (let j = i + 1; j < lines.length; j++) {
                    if (lines[j].trim() && !lines[j].startsWith('#')) {
                        channelUrl = lines[j].trim();
                        break;
                    }
                }
                
                if (channelUrl) {
                    channels.push({ title, url: channelUrl, logo });
                }
            }
        }

        render(channels);
    }

    function render(list) {
        playlistDiv.innerHTML = "";
        if (list.length === 0) {
            playlistDiv.innerHTML = '<div class="status">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ùˆ Ù…Ù„Ù M3U ÙØ¹Ù„ÙŠ.</div>';
            return;
        }

        list.forEach(ch => {
            const item = document.createElement('div');
            item.className = 'channel-card';
            item.innerHTML = `<img src="${ch.logo}"> <span>${ch.title}</span>`;
            item.onclick = () => play(ch.url);
            playlistDiv.appendChild(item);
        });
    }

    function play(url) {
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
        }
    }
</script>
</body>
</html>

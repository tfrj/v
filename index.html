<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¨ÙŠØ³ØªÙˆÙ† - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
            authDomain: "videos-5e336.firebaseapp.com",
            databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
            projectId: "videos-5e336",
            storageBucket: "videos-5e336.firebasestorage.app",
            messagingSenderId: "300218651134",
            appId: "1:300218651134:web:4bd24df8e555e62828f0af"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const videoRef = ref(db, 'videoStatus');

        const video = document.getElementById('video');
        const urlInput = document.getElementById('videoUrl');
        let isUpdatingLocally = false;

        // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«
        window.playM3U8 = function() {
            const videoSrc = urlInput.value;
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(videoSrc);
                hls.attachMedia(video);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc;
            }
        };

        // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Firebase Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        video.onplay = () => {
            if (!isUpdatingLocally) {
                set(videoRef, { playing: true, time: video.currentTime, lastUpdated: Date.now() });
            }
        };

        video.onpause = () => {
            if (!isUpdatingLocally) {
                set(videoRef, { playing: false, time: video.currentTime, lastUpdated: Date.now() });
            }
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
        video.onseeked = () => {
            if (!isUpdatingLocally) {
                set(videoRef, { playing: !video.paused, time: video.currentTime, lastUpdated: Date.now() });
            }
        };

        // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† Firebase ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        onValue(videoRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                isUpdatingLocally = true; // Ù„Ù…Ù†Ø¹ Ø­Ø¯ÙˆØ« Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø± Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ©

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
                if (Math.abs(video.currentTime - data.time) > 1.5) {
                    video.currentTime = data.time;
                }

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø¥ÙŠÙ‚Ø§Ù
                if (data.playing && video.paused) {
                    video.play().catch(e => console.log("ØªØ­ØªØ§Ø¬ Ù„Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© Ø£ÙˆÙ„Ø§Ù‹"));
                } else if (!data.playing && !video.paused) {
                    video.pause();
                }

                isUpdatingLocally = false;
            }
        });

        window.onload = playM3U8;
    </script>

    <style>
        :root { --primary: #e67e22; --bg: #121212; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .input-group { width: 100%; max-width: 500px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        input { padding: 15px; border-radius: 10px; border: none; background: #222; color: #00d2ff; font-size: 14px; direction: ltr; }
        button { padding: 15px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .player-card { width: 100%; max-width: 800px; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        video { width: 100%; aspect-ratio: 16 / 9; background: #000; }
        .status-bar { background: #1a1a1a; padding: 10px; font-size: 12px; text-align: center; color: #888; }
    </style>
</head>
<body>

    <div class="input-group">
        <input type="text" id="videoUrl" value="https://shd-gcp-live.edgenextcdn.net/live/bitmovin-spacetoon/d8382fb9ab4b2307058f12c7ea90db54/index.m3u8" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«">
        <button onclick="playM3U8()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ğŸ“º</button>
    </div>

    <div class="player-card">
        <video id="video" controls playsinline></video>
        <div class="status-bar">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø´Ø· - Ø£ÙŠ Ø­Ø±ÙƒØ© ØªÙ‚ÙˆÙ… Ø¨Ù‡Ø§ Ø³ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</div>
    </div>

</body>
</html>

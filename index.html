<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VHS Cinema Experience</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root { --navy: #151b4e; --white: #ffffff; }
        
        /* جعل الصفحة تغطي كامل مساحة الهاتف حتى منطقة النوتش */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #000; font-family: 'Courier New', monospace;
            overflow: hidden; position: fixed;
        }

        /* الحاوية الرئيسية بوضع ملء الشاشة المطلق */
        .cinema-viewport {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        /* التشويش البرمجي يملأ الخلفية */
        #noise-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; opacity: 0.8;
        }

        /* الفيديو - تم ضبطه ليغطي كامل الشاشة حرفياً */
        video { 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%; 
            object-fit: fill; /* هذا يضمن تمدد الفيديو ليملأ كل الزوايا بدون فراغات */
            z-index: 3; display: none; 
        }

        /* بوابة الدخول - شفافة وعائمة في المنتصف */
        #auth-gate {
            position: absolute;
            z-index: 100;
            width: 80%;
            max-width: 300px;
            background: rgba(21, 27, 78, 0.7);
            border: 1px solid var(--white);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(8px);
            border-radius: 2px;
        }

        .input-style {
            width: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--white);
            color: var(--white);
            padding: 12px;
            text-align: center;
            font-family: inherit;
            outline: none;
            box-sizing: border-box;
        }

        /* لوحة المشرف - مخفية في الأسفل لتظهر عند الحاجة */
        #admin-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 110;
            width: 85%;
            max-width: 400px;
            display: none;
            background: rgba(21, 27, 78, 0.9);
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .count-badge {
            position: absolute;
            top: env(safe-area-inset-top, 20px); /* يراعي مكان الكاميرا في الآيفون */
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: #00ff00;
            padding: 20px 10px;
            font-size: 10px;
            z-index: 150;
            border-radius: 50%;
            border: 1px solid rgba(0,255,0,0.3);
        }

        .admin-btns { display: flex; gap: 8px; margin-top: 10px; }
        button { flex: 1; background: #151b4e; border: 1px solid #fff; color: #fff; padding: 10px; cursor: pointer; font-size: 9px; }
    </style>
</head>
<body onclick="activateTheater()">

    <div class="cinema-viewport">
        <div id="user-count-badge" class="count-badge">● <span id="user-count">0</span></div>
        
        <canvas id="noise-canvas"></canvas>
        <video id="video-player" playsinline muted autoplay></video>

        <div id="auth-gate">
            <input type="password" id="pass-input" class="input-style" placeholder="ENTER ACCESS CODE">
        </div>

        <div id="admin-panel">
            <input type="text" id="url-input" class="input-style" placeholder="PASTE LINK HERE">
            <div class="admin-btns">
                <button onclick="ejectStream()" style="color: #ff4d4d;">EJECT</button>
                <button onclick="logoutAdmin()">LOGOUT</button>
            </div>
        </div>
    </div>

    <audio id="noise-audio" loop>
        <source src="https://www.soundjay.com/tv-static-05.mp3" type="audio/mpeg">
    </audio>

<script>
    const canvas = document.getElementById('noise-canvas');
    const ctx = canvas.getContext('2d');
    const noiseAudio = document.getElementById('noise-audio');
    const video = document.getElementById('video-player');
    const authGate = document.getElementById('auth-gate');
    const adminPanel = document.getElementById('admin-panel');
    let noiseID, audioActive = false;

    // تفعيل وضع السينما (الصوت والتشويش)
    function activateTheater() {
        if (!audioActive) {
            noiseAudio.play().then(() => { if(video.style.display === 'block') noiseAudio.pause(); }).catch(() => {});
            audioActive = true;
        }
    }

    function renderStatic() {
        canvas.width = 300; canvas.height = 200;
        const idata = ctx.createImageData(canvas.width, canvas.height);
        const b32 = new Uint32Array(idata.data.buffer);
        for (let i = 0; i < b32.length; i++) b32[i] = ((Math.random() * 255) | 0) << 24 | (Math.random() * 0xffffff);
        ctx.putImageData(idata, 0, 0);
        noiseID = requestAnimationFrame(renderStatic);
    }

    function setMode(isStreaming) {
        if (!isStreaming) {
            video.style.display = 'none';
            canvas.style.display = 'block';
            if (!noiseID) renderStatic();
            if (audioActive) noiseAudio.play().catch(() => {});
        } else {
            canvas.style.display = 'none';
            video.style.display = 'block';
            cancelAnimationFrame(noiseID); noiseID = null;
            noiseAudio.pause();
        }
    }

    // --- Firebase Core (لا نلمس منطق عملك الأصلي) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
        authDomain: "videos-5e336.firebaseapp.com",
        databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
        projectId: "videos-5e336",
        storageBucket: "videos-5e336.firebasestorage.app",
        messagingSenderId: "300218651134",
        appId: "1:300218651134:web:4bd24df8e555e62828f0af"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const syncRef = db.ref('videoSync');

    auth.onAuthStateChanged(user => {
        if (user && user.email === "t@t.tt") {
            authGate.style.display = 'none';
            adminPanel.style.display = 'block';
        }
    });

    document.getElementById('pass-input').addEventListener('input', (e) => {
        if (e.target.value.length >= 6) auth.signInWithEmailAndPassword("t@t.tt", e.target.value).catch(() => {});
    });

    document.getElementById('url-input').addEventListener('input', (e) => {
        const val = e.target.value.trim();
        if (val.startsWith('http')) {
            syncRef.set({ url: val, currentTime: 0, isPlaying: true, lastUpdated: Date.now() });
            e.target.value = "";
        }
    });

    syncRef.on('value', snap => {
        const data = snap.val();
        if (!data || !data.url) {
            setMode(false);
            video.pause();
        } else {
            setMode(true);
            if (video.src !== data.url && !video.src.includes(data.url)) loadAndPlay(data.url);
        }
    });

    function loadAndPlay(url) {
        if (url.includes('.m3u8')) {
            const hls = new Hls(); hls.loadSource(url); hls.attachMedia(video);
        } else { video.src = url; }
        video.play().catch(() => {});
    }

    db.ref('viewers').on('value', s => document.getElementById('user-count').innerText = s.numChildren());
    function ejectStream() { if (confirm("EJECT?")) syncRef.set(null); }
    function logoutAdmin() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
